<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VK Ads Message Builder (Groups→Campaigns + Campaign Names)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --line:#243044;
      --btn:#2563eb;
      --btn2:#334155;
      --bad:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#070a10 0%, #0b0f17 100%);
      color:var(--text);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{font-size:18px;margin:0 0 14px}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(17,24,39,.85);
      border:1px solid rgba(36,48,68,.8);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted);font-size:12px}
    input[type="text"], textarea, select{
      width:100%;
      background:#0b1220;
      color:var(--text);
      border:1px solid rgba(36,48,68,.9);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:640px;resize:vertical;white-space:pre-wrap}
    .small{font-size:12px;color:var(--muted)}
    .btn{
      background:var(--btn);
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:transparent;border:1px solid rgba(239,68,68,.7);color:var(--bad)}
    .btn.mini{padding:7px 10px;border-radius:10px;font-weight:600;font-size:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(36,48,68,.9);
      background:#0b1220;color:var(--muted);
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    .seg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .hr{height:1px;background:rgba(36,48,68,.9);margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{
      border-bottom:1px solid rgba(36,48,68,.7);
      padding:8px 6px;
      vertical-align:top;
    }
    th{color:var(--muted);font-size:12px;text-align:left}
    td input[type="text"]{padding:8px;border-radius:9px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .nowrap{white-space:nowrap}
    .stickyTop{position:sticky; top:12px;}
    .checkCell{width:44px;text-align:center;}
    input[type="checkbox"]{width:18px;height:18px;accent-color: var(--btn);}
    .actionsCell{width:170px}
    .detailsRow td{background:rgba(11,18,32,.45)}
    .innerTable{width:100%;border-collapse:collapse;margin-top:6px}
    .innerTable th,.innerTable td{border-bottom:1px solid rgba(36,48,68,.55);padding:6px 6px}
    .mutedLine{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VK Ads → Сообщение по шаблону (агрегация групп → кампании + названия кампаний из отчёта)</h1>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="flex:1">
            <div style="min-width:260px;flex:1">
              <label>1) Отчёт по группам (.xlsx)</label>
              <input id="fileGroups" type="file" accept=".xlsx,.xls" />
            </div>
            <div style="min-width:260px;flex:1">
              <label>2) Отчёт по кампаниям (.xlsx)</label>
              <input id="fileCampaigns" type="file" accept=".xlsx,.xls" />
            </div>
          </div>
          <div class="row">
            <span id="statusPill" class="pill">
              <span class="seg"><span id="dotGroups" class="dot bad"></span><span id="txtGroups">Группы: нет</span></span>
              <span class="seg"><span id="dotCampaigns" class="dot bad"></span><span id="txtCampaigns">Кампании: имена не загружены</span></span>
            </span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1;min-width:260px">
            <label>Заголовок сообщения (строка с ✅)</label>
            <input id="title" type="text" placeholder="Например: SAYAN - Гордая" />
          </div>
          <div style="flex:1;min-width:260px">
            <label>Строка итогов (➡ ... - все кампании)</label>
            <input id="totalLabel" type="text" placeholder="Например: SAYAN - Гордая (скрытые) - все кампании" />

            <div style="margin-top:10px">
              <label>Статус итогового сообщения</label>
              <select id="totalStatus">
                <option value="">(оставить пустым)</option>
                <option value="Модерация">Модерация</option>
                <option value="Обучение">Обучение</option>
                <option value="Идут показы">Идут показы</option>
                <option value="Остановлена">Остановлена</option>
                <option value="Финал">Финал</option>
              </select>
              <div class="small" style="margin-top:6px">
                Для последнего суммарного сообщения.
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:700">Кампании / группы и комментарии</div>
            <div class="small">Можно исключать кампании целиком или отдельные группы внутри кампании.</div>
          </div>
          <div class="row">
            <span class="pill">Статус кампании: <span class="ok">active</span> если есть активные группы, иначе <span class="bad">blocked</span></span>
          </div>
        </div>

        <div class="hr"></div>

        <div id="tableWrap" class="small">Пока нет данных.</div>

        <div class="hr"></div>

        <div class="row">
          <button id="btnGenerate" class="btn" disabled>Сформировать сообщение</button>
          <span class="small" id="hint"></span>
        </div>
      </div>

      <div class="card stickyTop">
        <label>Сообщение</label>
        <textarea id="output" class="mono" placeholder="Здесь появится сообщение…"></textarea>
        <div class="hr"></div>
        <div class="row">
          <button id="btnCopy" class="btn secondary" disabled>Скопировать</button>
          <span class="small" id="copyHint"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const els = {
      fileGroups: document.getElementById('fileGroups'),
      fileCampaigns: document.getElementById('fileCampaigns'),
      statusPill: document.getElementById('statusPill'),
      dotGroups: document.getElementById('dotGroups'),
      dotCampaigns: document.getElementById('dotCampaigns'),
      txtGroups: document.getElementById('txtGroups'),
      txtCampaigns: document.getElementById('txtCampaigns'),
      btnGenerate: document.getElementById('btnGenerate'),
      btnCopy: document.getElementById('btnCopy'),
      output: document.getElementById('output'),
      tableWrap: document.getElementById('tableWrap'),
      title: document.getElementById('title'),
      totalLabel: document.getElementById('totalLabel'),
      totalStatus: document.getElementById('totalStatus'),
      hint: document.getElementById('hint'),
      copyHint: document.getElementById('copyHint'),
    };

    // --- State ---
    let groupRows = [];                          // groups report rows (normalized keys)
    let campaignsAgg = [];                       // aggregated campaigns
    const campaignNamesFromReport = new Map();   // id -> name (from campaigns report)  [PRIORITY #1]
    const campaignAutoOverrides = new Map();     // id -> name (manual override)        [PRIORITY #2]
    const campaignComments = new Map();          // id -> comment
    const campaignIncluded = new Map();          // id -> boolean include (campaign)
    const deletedCampaigns = new Set();          // ids hidden from UI
    const groupIncluded = new Map();             // groupId -> boolean include (within campaign)

    let totalsIncluded = true;                   // include totals block
    let totalComment = '';

    let groupsLoaded = false;
    let campaignsReportLoaded = false;

    const nfInt = new Intl.NumberFormat('ru-RU');
    const nfMoney = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // Normalization:
    // - collapse multiple spaces
    // - trim start/end
    // This handles headers like "Потрачено всего, ₽ " vs "Потрачено всего, ₽".
    function normKey(k){ return String(k ?? '').replace(/\\s+/g,' ').trim(); }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeHtmlAttr(s){ return escapeHtml(s).replaceAll('\\n',' '); }

    // Get value by header name (order-independent)
    function getVal(row, keyCandidates){
      for (const k of keyCandidates){
        const nk = normKey(k);
        if (Object.prototype.hasOwnProperty.call(row, nk)) return row[nk];
      }
      return undefined;
    }

    function asNumber(x){
      if (x === null || x === undefined) return 0;
      if (typeof x === 'number') return isFinite(x) ? x : 0;
      const s = String(x).replace(/\\s/g,'').replace(',', '.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }
    function asInt(x){ return Math.round(asNumber(x)); }
    function fmtInt(x){ return nfInt.format(asInt(x)); }
    function fmtMoney(x){ return nfMoney.format(asNumber(x)).replace(/\\u00A0/g,' '); }

    function statusText(raw){
      const s = String(raw ?? '').toLowerCase().trim();
      if (s === 'active') return 'Идут показы';
      if (s === 'blocked') return 'Остановлена';
      if (!s) return '';
      return s;
    }

    function groupStatusToCampaign(statuses){
      const norm = statuses.map(s => String(s ?? '').toLowerCase().trim()).filter(Boolean);
      if (norm.includes('active')) return 'active';
      if (norm.length && norm.every(s => s === 'blocked')) return 'blocked';
      return norm[0] || '';
    }

    function guessArtistTrackFullFromName(name){
      const parts = String(name ?? '').split(' - ').map(p => p.trim()).filter(Boolean);
      if (parts.length >= 2){
        const artist = parts[0];
        const track = parts.slice(1).join(' - ');
        return `${artist} - ${track}`;
      }
      return String(name ?? '').trim();
    }
    function removeTrailingParen(trackPart){
      return String(trackPart ?? '').replace(/\\s*\\([^)]*\\)\\s*$/,'').trim();
    }

    // PRIORITY: 1) campaigns report 2) manual override 3) empty
    function resolveCampaignNameForUI(id){
      const fromReport = (campaignNamesFromReport.get(id) || '').trim(); // priority #1
      const override = (campaignAutoOverrides.get(id) || '').trim();     // priority #2
      return (override || fromReport || '').trim();
    }

    // For message: avoid empty "➡ " line by falling back to ID if name is empty
    function resolveCampaignNameForMessage(id){
      const name = resolveCampaignNameForUI(id);
      return name || `ID кампании ${id}`;
    }

    function ensureIncludeState(){
      for (const c of campaignsAgg){
        if (!campaignIncluded.has(c.id)) campaignIncluded.set(c.id, true);
      }
    }

    function setPill(){
      // 4-state indicator: green/red independently for groups + campaign-names
      els.txtGroups.textContent = groupsLoaded ? 'Группы: загружено' : 'Группы: нет';
      els.dotGroups.classList.toggle('ok', groupsLoaded);
      els.dotGroups.classList.toggle('bad', !groupsLoaded);

      els.txtCampaigns.textContent = campaignsReportLoaded ? 'Кампании: имена загружены' : 'Кампании: имена не загружены';
      els.dotCampaigns.classList.toggle('ok', campaignsReportLoaded);
      els.dotCampaigns.classList.toggle('bad', !campaignsReportLoaded);
    }

    function aggregateToCampaigns(){
      // Flexible headers (by name, order-independent)
      const KEY_CAMPAIGN_ID = ['ID кампании','Campaign ID','campaign_id','CampaignId'];
      const KEY_GROUP_ID    = ['ID группы','Group ID','group_id','GroupId'];
      const KEY_GROUP_NAME  = ['Название группы','Group name','group_name','Name'];

      const KEY_STATUS      = ['Статус'];
      const KEY_SPEND       = ['Потрачено всего, ₽', 'Потрачено, ₽'];
      const KEY_IMP         = ['Показы'];
      const KEY_LISTEN      = ['Начали прослушивание'];
      const KEY_ADDS        = ['Добавили аудио'];

      const map = new Map();

      for (const r of groupRows){
        const gid = String(getVal(r, KEY_GROUP_ID) ?? '').trim();
        const gname = String(getVal(r, KEY_GROUP_NAME) ?? '').trim();

        // 1) preferred: campaign id
        // 2) fallback: group id (so сервис не ломается, если в выгрузке нет ID кампании)
        const cidRaw = getVal(r, KEY_CAMPAIGN_ID);
        const cid = String((cidRaw ?? '')).trim() || (gid ? `G:${gid}` : '');

        if (!cid) continue;

        // group-level include
        const gKey = gid ? String(gid) : `${cid}::${gname || 'group'}`;
        const gInc = groupIncluded.get(gKey) !== false;
        if (!gInc) continue;

        const st = String(getVal(r, KEY_STATUS) ?? '').trim();
        const spend = asNumber(getVal(r, KEY_SPEND));
        const imp = asInt(getVal(r, KEY_IMP));
        const listen = asInt(getVal(r, KEY_LISTEN));
        const adds = asInt(getVal(r, KEY_ADDS));

        if (!map.has(cid)){
          map.set(cid, { id: cid, statuses: [], spend: 0, imp: 0, listen: 0, adds: 0, totalGroups: 0, groups: [] });
        }
        const a = map.get(cid);
        a.totalGroups += 1;
        a.statuses.push(st);
        a.spend += spend;
        a.imp += imp;
        a.listen += listen;
        a.adds += adds;
        a.groups.push({
          gid: gKey,
          gidRaw: gid,
          name: gname,
          status: st,
          spend, imp, listen, adds
        });
      }

      const list = [];
      for (const a of map.values()){
        list.push({
          id: a.id,
          statusRaw: groupStatusToCampaign(a.statuses),
          spend: a.spend,
          imp: a.imp,
          listen: a.listen,
          adds: a.adds,
          groupsCount: a.totalGroups,
          groups: a.groups
        });
      }

      list.sort((x,y)=>{
        const nx = resolveCampaignNameForUI(x.id) || '';
        const ny = resolveCampaignNameForUI(y.id) || '';
        // empty names go last
        if (!nx && ny) return 1;
        if (nx && !ny) return -1;
        return nx.localeCompare(ny, 'ru', { sensitivity:'base' });
      });

      campaignsAgg = list.filter(c => !deletedCampaigns.has(c.id));
      ensureIncludeState();
    }

    function guessTitleAndTotalsLabel(){
      if (!campaignsAgg.length) return;

      // Find first campaign with a non-empty name
      const firstNamed = campaignsAgg.find(c => !!resolveCampaignNameForUI(c.id));
      if (!firstNamed) return;

      const baseName = resolveCampaignNameForUI(firstNamed.id);
      const full = guessArtistTrackFullFromName(baseName);
      const parts = full.split(' - ').map(s=>s.trim()).filter(Boolean);

      if (!els.title.value.trim() && parts.length >= 2){
        const artist = parts[0];
        const track = removeTrailingParen(parts.slice(1).join(' - '));
        els.title.value = `${artist} - ${track}`;
      }

      if (!els.totalLabel.value.trim()){
        els.totalLabel.value = `${full} - все кампании`;
      }
    }

    function buildMessage(){
      const title = (els.title.value || '').trim();
      const totalsLabel = (els.totalLabel.value || '').trim();
      let out = '';
      if (title) out += `✅ ${title}\\n\\n`;

      // Totals over ALL included groups/campaigns (respects deletions/exclusions at UI level)
      let sumSpend = 0, sumImp = 0, sumListen = 0, sumAdds = 0;
      for (const c of campaignsAgg){
        const includeCampaign = campaignIncluded.get(c.id) !== false;
        if (!includeCampaign) continue;
        sumSpend += asNumber(c.spend);
        sumImp += asInt(c.imp);
        sumListen += asInt(c.listen);
        sumAdds += asInt(c.adds);
      }

      // Output only included campaigns
      for (const c of campaignsAgg){
        const include = campaignIncluded.get(c.id) !== false;
        if (!include) continue;

        const name = resolveCampaignNameForMessage(c.id);
        const comment = campaignComments.get(c.id) || '';

        const spend = asNumber(c.spend);
        const imp = asInt(c.imp);
        const listen = asInt(c.listen);
        const adds = asInt(c.adds);

        out += `➡ ${name}\\n\\n`;
        out += `Потрачено: ${fmtMoney(spend)} ₽\\n`;
        out += `Показы: ${fmtInt(imp)}\\n`;
        out += `Начали прослушивание: ${fmtInt(listen)}\\n`;
        out += `Добавлено: ${fmtInt(adds)}\\n`;

        const cpa = (adds > 0) ? (spend / adds) : 0;
        out += `Ср. стоимость добавления: ${adds>0 ? (fmtMoney(cpa) + ' ₽') : '—'}\\n\\n`;

        out += `Статус: ${statusText(c.statusRaw)}\\n`;
        out += `Комментарий: ${comment}\\n\\n`;
      }

      if (totalsLabel && totalsIncluded){
        const totalCpa = (sumAdds > 0) ? (sumSpend / sumAdds) : 0;
        out += `➡ ${totalsLabel}\\n\\n`;
        out += `Потрачено: ${fmtMoney(sumSpend)} ₽\\n`;
        out += `Показы: ${fmtInt(sumImp)}\\n`;
        out += `Начали прослушивание: ${fmtInt(sumListen)}\\n`;
        out += `Добавлено: ${fmtInt(sumAdds)}\\n`;
        out += `Ср. стоимость добавления: ${sumAdds>0 ? (fmtMoney(totalCpa) + ' ₽') : '—'}\\n\\n`;

        const totalStatus = (els.totalStatus?.value || '').trim();
        out += `Статус: ${totalStatus}\\nКомментарий: ${totalComment}\\n`;
      }

      els.output.value = out.trim() + '\\n';
      els.btnCopy.disabled = !els.output.value.trim();
    }

    function renderTable(){
      if (!campaignsAgg.length){
        els.tableWrap.innerHTML = 'Сначала загрузите отчёт по группам.';
        return;
      }

      let html = `<table>
        <thead><tr>
          <th class="checkCell">✓</th>
          <th style="width:44%">Название кампании (авто)</th>
          <th style="width:14%">Статус</th>
          <th style="width:34%">Комментарий</th>
          <th class="actionsCell">Действия</th>
        </tr></thead><tbody>`;

      html += `<tr>
        <td class="checkCell">
          <input id="totalsInclude" type="checkbox" ${totalsIncluded ? 'checked' : ''} title="Показывать итоговый блок в сообщении">
        </td>
        <td><b>Итог (сумма по включённым кампаниям)</b></td>
        <td></td>
        <td>
          <input id="totalCommentInput" type="text" placeholder="Комментарий к суммарному блоку" value="${escapeHtmlAttr(totalComment)}">
        </td>
        <td></td>
      </tr>`;

      for (const c of campaignsAgg){
        const stRaw = String(c.statusRaw || '').trim();
        const curComment = campaignComments.get(c.id) || '';
        const include = campaignIncluded.get(c.id) !== false;

        const fromReport = (campaignNamesFromReport.get(c.id) || '').trim();
        const override = (campaignAutoOverrides.get(c.id) || '').trim();
        const displayName = resolveCampaignNameForUI(c.id); // may be empty

        const src = override ? 'ручн.' : (fromReport ? 'из отчёта кампаний' : '—');
        const isFallbackGroupAsCampaign = String(c.id || '').startsWith('G:');

        html += `<tr>
          <td class="checkCell">
            <input data-include="${escapeHtmlAttr(c.id)}" type="checkbox" ${include ? 'checked' : ''} title="Включать кампанию в сообщение">
          </td>
          <td>
            <div class="small">ID: <span class="mono">${escapeHtml(c.id)}</span> · групп: ${escapeHtml(String(c.groupsCount))} · источник: ${escapeHtml(src)}${isFallbackGroupAsCampaign ? ' · <span class="mutedLine">режим без ID кампании</span>' : ''}</div>
            <input data-cauto="${escapeHtmlAttr(c.id)}" type="text" value="${escapeHtmlAttr(displayName)}" placeholder="(пусто) — введи название кампании">
            ${fromReport ? `<div class="small">Из отчёта кампаний: ${escapeHtml(fromReport)}</div>` : `<div class="small">Из отчёта кампаний: —</div>`}
          </td>
          <td>
            <span class="nowrap">${escapeHtml(statusText(stRaw))}</span>
            <div class="small mono">${escapeHtml(stRaw)}</div>
          </td>
          <td>
            <input data-ccomment="${escapeHtmlAttr(c.id)}" type="text" placeholder="Оставить пустым" value="${escapeHtmlAttr(curComment)}">
          </td>
          <td class="actionsCell">
            <div class="row" style="gap:8px;flex-wrap:nowrap">
              <button class="btn secondary mini" data-toggle="${escapeHtmlAttr(c.id)}">Группы</button>
              <button class="btn danger mini" data-delc="${escapeHtmlAttr(c.id)}">Удалить</button>
            </div>
          </td>
        </tr>`;

        // details row
        html += `<tr class="detailsRow" data-details="${escapeHtmlAttr(c.id)}" style="display:none">
          <td colspan="5">
            <div class="small">Группы внутри кампании (можно исключить конкретную группу):</div>
            <table class="innerTable">
              <thead>
                <tr>
                  <th style="width:44px;text-align:center">✓</th>
                  <th>Группа</th>
                  <th style="width:160px">Статус</th>
                  <th style="width:220px">Метрики</th>
                  <th style="width:110px">Действие</th>
                </tr>
              </thead>
              <tbody>
                ${c.groups.map(g => {
                  const gInc = groupIncluded.get(String(g.gid)) !== false;
                  const gTitle = (g.name || '').trim() ? escapeHtml(g.name) : '<span class="mutedLine">(без названия)</span>';
                  const gIdText = g.gidRaw ? `ID: <span class="mono">${escapeHtml(String(g.gidRaw))}</span>` : `Key: <span class="mono">${escapeHtml(String(g.gid))}</span>`;
                  const metrics = `Показы: ${fmtInt(g.imp)} · Добавлено: ${fmtInt(g.adds)} · Потрачено: ${fmtMoney(g.spend)} ₽`;
                  return `<tr>
                    <td style="text-align:center">
                      <input type="checkbox" data-ginclude="${escapeHtmlAttr(g.gid)}" ${gInc ? 'checked' : ''} title="Включать группу">
                    </td>
                    <td>
                      <div>${gTitle}</div>
                      <div class="small">${gIdText}</div>
                    </td>
                    <td>
                      <span class="nowrap">${escapeHtml(statusText(g.status))}</span>
                      <div class="small mono">${escapeHtml(String(g.status||''))}</div>
                    </td>
                    <td class="small">${escapeHtml(metrics)}</td>
                    <td>
                      <button class="btn danger mini" data-delg="${escapeHtmlAttr(g.gid)}">Удалить</button>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </td>
        </tr>`;
      }

      html += `</tbody></table>`;
      els.tableWrap.innerHTML = html;

      // totals controls
      const totalsCb = document.getElementById('totalsInclude');
      if (totalsCb){
        totalsCb.addEventListener('change', (e)=>{
          totalsIncluded = !!e.target.checked;
          buildMessage();
        });
      }
      const totalInp = document.getElementById('totalCommentInput');
      if (totalInp){
        totalInp.addEventListener('input', (e)=>{
          totalComment = e.target.value;
          buildMessage();
        });
      }

      // campaign include
      els.tableWrap.querySelectorAll('input[data-include]').forEach(inp => {
        inp.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-include');
          campaignIncluded.set(id, !!e.target.checked);
          buildMessage();
        });
      });

      // campaign name override
      els.tableWrap.querySelectorAll('input[data-cauto]').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-cauto');
          const val = String(e.target.value || '');
          if (val.trim()){
            campaignAutoOverrides.set(id, val);
          } else {
            campaignAutoOverrides.delete(id);
          }
          // keep ordering stable after renaming
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });

      // campaign comment
      els.tableWrap.querySelectorAll('input[data-ccomment]').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-ccomment');
          campaignComments.set(id, e.target.value);
          buildMessage();
        });
      });

      // toggle details
      els.tableWrap.querySelectorAll('button[data-toggle]').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const id = e.target.getAttribute('data-toggle');
          const row = els.tableWrap.querySelector(`tr[data-details="${CSS.escape(id)}"]`);
          if (!row) return;
          row.style.display = (row.style.display === 'none' || !row.style.display) ? '' : 'none';
        });
      });

      // delete campaign (hide)
      els.tableWrap.querySelectorAll('button[data-delc]').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const id = e.target.getAttribute('data-delc');
          deletedCampaigns.add(id);
          campaignIncluded.set(id, false);
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });

      // group include
      els.tableWrap.querySelectorAll('input[data-ginclude]').forEach(inp => {
        inp.addEventListener('change', (e)=>{
          const gid = e.target.getAttribute('data-ginclude');
          groupIncluded.set(gid, !!e.target.checked);
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });

      // delete group (exclude)
      els.tableWrap.querySelectorAll('button[data-delg]').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const gid = e.target.getAttribute('data-delg');
          groupIncluded.set(gid, false);
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });
    }

    async function parseXlsx(file){
      const buf = await file.arrayBuffer();
      return XLSX.read(buf, { type:'array' });
    }

    function sheetToRowsNormalized(wb, preferredSheetName){
      const sheetName = (preferredSheetName && wb.SheetNames.includes(preferredSheetName))
        ? preferredSheetName
        : wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const raw = XLSX.utils.sheet_to_json(ws, { defval: '' });
      return raw.map(obj => {
        const out = {};
        for (const [k,v] of Object.entries(obj)){
          out[normKey(k)] = v;
        }
        return out;
      });
    }

    async function handleGroupsFile(file){
      const wb = await parseXlsx(file);

      // Prefer "Группы", but tolerate a file where sheet name differs.
      groupRows = sheetToRowsNormalized(wb, 'Группы');
      groupsLoaded = groupRows.length > 0;

      if (!groupsLoaded){
        campaignsAgg = [];
        return { missing: ['(пустой файл)'] };
      }

      // required for normal mode (campaign aggregation). If there is no ID кампании, we still continue in fallback mode.
      const mustSoft = ['Статус','Потрачено всего, ₽','Показы','Начали прослушивание','Добавили аудио'];
      const cols = new Set(Object.keys(groupRows[0] || {}));
      const missing = mustSoft.filter(m => !cols.has(normKey(m)));

      aggregateToCampaigns();
      guessTitleAndTotalsLabel();
      return { missing, hasCampaignId: cols.has('ID кампании') };
    }

    async function handleCampaignsFile(file){
      const wb = await parseXlsx(file);
      const rows = sheetToRowsNormalized(wb, 'Кампании');

      campaignNamesFromReport.clear();

      const KEY_ID = ['ID кампании','Campaign ID','campaign_id','CampaignId'];
      const KEY_NAME = ['Название кампании','Campaign name','campaign_name','Name'];

      for (const r of rows){
        const id = String(getVal(r, KEY_ID) ?? '').trim();
        const name = String(getVal(r, KEY_NAME) ?? '').trim();
        if (id && name) campaignNamesFromReport.set(id, name);
      }

      campaignsReportLoaded = campaignNamesFromReport.size > 0;

      if (groupsLoaded){
        aggregateToCampaigns();
        guessTitleAndTotalsLabel();
        renderTable();
        buildMessage();
      }

      return { count: campaignNamesFromReport.size };
    }

    function resetForNewGroups(){
      campaignsAgg = [];
      groupRows = [];
      campaignComments.clear();
      campaignAutoOverrides.clear();
      campaignIncluded.clear();
      deletedCampaigns.clear();
      groupIncluded.clear();
      totalsIncluded = true;
      totalComment = '';
      if (els.totalStatus) els.totalStatus.value = '';
      els.output.value = '';
      els.btnGenerate.disabled = true;
      els.btnCopy.disabled = true;
      els.hint.textContent = '';
      els.copyHint.textContent = '';
    }

    els.fileGroups.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      resetForNewGroups();

      if (!f){
        groupsLoaded = false;
        setPill();
        renderTable();
        return;
      }

      try{
        const res = await handleGroupsFile(f);
        setPill();

        if (!groupsLoaded){
          els.hint.textContent = 'Файл групп пустой или не распознан.';
          renderTable();
          return;
        }

        if (!res.hasCampaignId){
          els.hint.textContent = 'В файле групп не найден столбец "ID кампании". Я сгруппирую данные по группам (fallback-режим). Если нужен режим кампаний — выгрузите отчёт, где есть "ID кампании".';
        } else if (res.missing.length){
          els.hint.textContent = `Не найдены колонки: ${res.missing.join(', ')}. Я всё равно попробую посчитать максимум возможного по найденным названиям.`;
        } else {
          els.hint.textContent = '';
        }

        renderTable();
        els.btnGenerate.disabled = false;

      }catch(err){
        console.error(err);
        groupsLoaded = false;
        setPill();
        els.hint.textContent = String(err?.message || err);
        renderTable();
      }
    });

    els.fileCampaigns.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f){
        campaignNamesFromReport.clear();
        campaignsReportLoaded = false;
        setPill();
        if (groupsLoaded){
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        }
        return;
      }

      try{
        const res = await handleCampaignsFile(f);
        setPill();
        els.hint.textContent = groupsLoaded
          ? `Загружены имена кампаний: ${res.count}.`
          : `Загружены имена кампаний: ${res.count}. Теперь загрузите отчёт по группам.`;
      }catch(err){
        console.error(err);
        campaignsReportLoaded = false;
        setPill();
        els.hint.textContent = String(err?.message || err);
      }
    });

    els.btnGenerate.addEventListener('click', ()=>{
      if (!groupsLoaded || !campaignsAgg.length) return;
      buildMessage();
      els.hint.textContent = 'Готово. Скопируй справа.';
    });

    els.btnCopy.addEventListener('click', async ()=>{
      const text = els.output.value || '';
      if (!text.trim()) return;
      try{
        await navigator.clipboard.writeText(text);
        els.copyHint.textContent = 'Скопировано в буфер обмена.';
      }catch(e){
        els.output.focus();
        els.output.select();
        document.execCommand('copy');
        els.copyHint.textContent = 'Скопировано (через выделение).';
      }
    });

    els.title.addEventListener('input', ()=>{ if (groupsLoaded) buildMessage(); });
    els.totalLabel.addEventListener('input', ()=>{ if (groupsLoaded) buildMessage(); });
    els.totalStatus.addEventListener('change', ()=>{ if (groupsLoaded) buildMessage(); });

    setPill();
  </script>
</body>
</html>
