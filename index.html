<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VK Ads Message Builder (Groups→Campaigns + Campaign Names)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --line:#243044;
      --btn:#2563eb;
      --btn2:#334155;
      --bad:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#070a10 0%, #0b0f17 100%);
      color:var(--text);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{font-size:18px;margin:0 0 14px}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(17,24,39,.85);
      border:1px solid rgba(36,48,68,.8);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted);font-size:12px}
    input[type="text"], textarea, select{
      width:100%;
      background:#0b1220;
      color:var(--text);
      border:1px solid rgba(36,48,68,.9);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:640px;resize:vertical;white-space:pre-wrap}
    .small{font-size:12px;color:var(--muted)}
    .btn{
      background:var(--btn);
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:transparent;border:1px solid rgba(239,68,68,.7);color:var(--bad)}
    .btn.mini{padding:7px 10px;border-radius:10px;font-weight:600;font-size:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(36,48,68,.9);
      background:#0b1220;color:var(--muted);
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    .seg{display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .hr{height:1px;background:rgba(36,48,68,.9);margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{
      border-bottom:1px solid rgba(36,48,68,.7);
      padding:8px 6px;
      vertical-align:top;
    }
    th{color:var(--muted);font-size:12px;text-align:left}
    td input[type="text"]{padding:8px;border-radius:9px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .nowrap{white-space:nowrap}
    .stickyTop{position:sticky; top:12px;}
    .checkCell{width:44px;text-align:center;}
    input[type="checkbox"]{width:18px;height:18px;accent-color: var(--btn);}
    .actionsCell{width:170px}
    .detailsRow td{background:rgba(11,18,32,.45)}
    .innerTable{width:100%;border-collapse:collapse;margin-top:6px}
    .innerTable th,.innerTable td{border-bottom:1px solid rgba(36,48,68,.55);padding:6px 6px}
    .mutedLine{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VK Ads → Сообщение по шаблону (агрегация групп → кампании + названия кампаний из отчёта)</h1>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="flex:1">
            <div style="min-width:260px;flex:1">
              <label>1) Отчёт по группам (.xlsx)</label>
              <input id="fileGroups" type="file" accept=".xlsx,.xls" />
              <div style="margin-top:8px"><button id="btnClearGroups" type="button" class="btn secondary mini">Убрать файл</button></div>
            </div>
            <div style="min-width:260px;flex:1">
              <label>2) Отчёт по кампаниям (.xlsx)</label>
              <input id="fileCampaigns" type="file" accept=".xlsx,.xls" />
              <div style="margin-top:8px"><button id="btnClearCampaigns" type="button" class="btn secondary mini">Убрать файл</button></div>
            </div>
          </div>
          <div class="row">
            <span id="statusPill" class="pill">
              <span class="seg"><span id="dotGroups" class="dot bad"></span><span id="txtGroups">Группы: нет</span></span>
              <span class="seg"><span id="dotCampaigns" class="dot bad"></span><span id="txtCampaigns">Кампании: имена не загружены</span></span>
            </span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1;min-width:260px">
            <label>Заголовок сообщения (строка с ✅)</label>
            <input id="title" type="text" placeholder="Например: SAYAN - Гордая" />
          </div>
          <div style="flex:1;min-width:260px">
            <label>Строка итогов (➡ ... - все кампании)</label>
            <input id="totalLabel" type="text" placeholder="Например: SAYAN - Гордая (скрытые) - все кампании" />

            <div style="margin-top:10px">
              <label>Статус итогового сообщения</label>
              <select id="totalStatus">
                <option value="">(оставить пустым)</option>
                <option value="Модерация">Модерация</option>
                <option value="Обучение">Обучение</option>
                <option value="Идут показы">Идут показы</option>
                <option value="Остановлена">Остановлена</option>
                <option value="Финал">Финал</option>
              </select>
              <div class="small" style="margin-top:6px">
                Для последнего суммарного сообщения.
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:700">Кампании / группы и комментарии</div>
            <div class="small">Можно исключать кампании целиком или отдельные группы внутри кампании.</div>
          </div>
          <div class="row">
            <span class="pill">Статус кампании: <span class="ok">active</span> если есть активные группы, иначе <span class="bad">blocked</span></span>
          </div>
        </div>

        <div class="hr"></div>

        <div id="tableWrap" class="small">Пока нет данных.</div>

        <div class="hr"></div>

        <div class="row">
          <button id="btnGenerate" class="btn" disabled>Сформировать сообщение</button>
          <span class="small" id="hint"></span>
        </div>
      </div>

      <div class="card stickyTop">
        <label>Сообщение</label>
        <textarea id="output" class="mono" placeholder="Здесь появится сообщение…"></textarea>
        <div class="hr"></div>
        <div class="row">
          <button id="btnCopy" class="btn secondary" disabled>Скопировать</button>
          <span class="small" id="copyHint"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const els = {
      fileGroups: document.getElementById('fileGroups'),
      fileCampaigns: document.getElementById('fileCampaigns'),
      btnClearGroups: document.getElementById('btnClearGroups'),
      btnClearCampaigns: document.getElementById('btnClearCampaigns'),
      dotGroups: document.getElementById('dotGroups'),
      dotCampaigns: document.getElementById('dotCampaigns'),
      txtGroups: document.getElementById('txtGroups'),
      txtCampaigns: document.getElementById('txtCampaigns'),
      btnGenerate: document.getElementById('btnGenerate'),
      btnCopy: document.getElementById('btnCopy'),
      output: document.getElementById('output'),
      tableWrap: document.getElementById('tableWrap'),
      title: document.getElementById('title'),
      totalLabel: document.getElementById('totalLabel'),
      totalStatus: document.getElementById('totalStatus'),
      hint: document.getElementById('hint'),
      copyHint: document.getElementById('copyHint'),
    };

    // --- State ---
    let groupRows = [];                          // groups report rows (normalized keys)
    let campaignsAgg = [];                       // aggregated campaigns (from groups)
    const campaignNamesFromReport = new Map();   // id -> name (from campaigns report)
    const campaignNameOverrides = new Map();     // id -> manual override (optional)
    const campaignComments = new Map();          // id -> comment
    const campaignIncluded = new Map();          // id -> boolean include
    const deletedCampaigns = new Set();          // ids hidden from UI (soft delete)

    let totalsIncluded = true;                   // include totals block
    let totalComment = '';

    let groupsLoaded = false;
    let campaignsReportLoaded = false;

    const nfInt = new Intl.NumberFormat('ru-RU');
    const nfMoney = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // --- Utils ---
    function normKey(k){
      // normalize header: trim + collapse spaces, including NBSP
      return String(k ?? '').replace(/\u00A0/g, ' ').replace(/\s+/g,' ').trim();
    }

    function asNumber(x){
      if (x === null || x === undefined) return 0;
      if (typeof x === 'number') return isFinite(x) ? x : 0;
      const s = String(x).replace(/\u00A0/g,' ').replace(/\s/g,'').replace(',', '.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }
    function asInt(x){ return Math.round(asNumber(x)); }
    function fmtInt(x){ return nfInt.format(asInt(x)); }
    function fmtMoney(x){ return nfMoney.format(asNumber(x)).replace(/\u00A0/g,' '); }

    function statusText(raw){
      const s = String(raw ?? '').toLowerCase().trim();
      if (s === 'active') return 'Идут показы';
      if (s === 'blocked') return 'Остановлена';
      if (!s) return '';
      return s;
    }

    function groupStatusToCampaign(statuses){
      const norm = statuses.map(s => String(s ?? '').toLowerCase().trim()).filter(Boolean);
      if (norm.includes('active')) return 'active';
      if (norm.length && norm.every(s => s === 'blocked')) return 'blocked';
      return norm[0] || '';
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeHtmlAttr(s){
      return escapeHtml(s).replaceAll('\n',' ');
    }

    function setPill(){
      els.txtGroups.textContent = groupsLoaded ? 'Группы: загружено' : 'Группы: нет';
      els.dotGroups.classList.toggle('ok', groupsLoaded);
      els.dotGroups.classList.toggle('bad', !groupsLoaded);

      els.txtCampaigns.textContent = campaignsReportLoaded ? 'Кампании: имена загружены' : 'Кампании: имена не загружены';
      els.dotCampaigns.classList.toggle('ok', campaignsReportLoaded);
      els.dotCampaigns.classList.toggle('bad', !campaignsReportLoaded);
    }

    // Read first sheet as array-of-objects with normalized headers
    function sheetToObjects(ws){
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      if (!aoa || !aoa.length) return [];

      // header row = first non-empty row
      let headerRowIdx = -1;
      for (let i=0; i<aoa.length; i++){
        const row = aoa[i];
        if (row && row.some(v => String(v ?? '').trim() !== '')){
          headerRowIdx = i;
          break;
        }
      }
      if (headerRowIdx < 0) return [];

      const headers = (aoa[headerRowIdx] || []).map(h => normKey(h));
      const out = [];
      for (let r = headerRowIdx + 1; r < aoa.length; r++){
        const row = aoa[r] || [];
        if (!row.some(v => String(v ?? '').trim() !== '')) continue; // skip empty
        const obj = {};
        for (let c=0; c<headers.length; c++){
          const key = headers[c];
          if (!key) continue;
          obj[key] = row[c];
        }
        out.push(obj);
      }
      return out;
    }

    // order-independent getter with normalization
    function getVal(row, candidates){
      for (const k of candidates){
        const nk = normKey(k);
        if (Object.prototype.hasOwnProperty.call(row, nk)) return row[nk];
      }
      return undefined;
    }

    function resolveCampaignNameForUI(id){
      const override = (campaignNameOverrides.get(id) || '').trim();
      const fromReport = (campaignNamesFromReport.get(id) || '').trim();
      return (override || fromReport || '').trim();
    }
    function resolveCampaignNameForMessage(id){
      const name = resolveCampaignNameForUI(id);
      return name || `ID кампании ${id}`;
    }

    function guessArtistTrackFullFromName(name){
      const parts = String(name ?? '').split(' - ').map(p => p.trim()).filter(Boolean);
      if (parts.length >= 2){
        const artist = parts[0];
        const track = parts.slice(1).join(' - ');
        return `${artist} - ${track}`;
      }
      return String(name ?? '').trim();
    }
    function removeTrailingParen(trackPart){
      return String(trackPart ?? '').replace(/\s*\([^)]*\)\s*$/,'').trim();
    }

    function guessTitleAndTotalsLabel(){
      if (!campaignsAgg.length) return;
      const firstNamed = campaignsAgg.find(c => !!resolveCampaignNameForUI(c.id));
      if (!firstNamed) return;

      const baseName = resolveCampaignNameForUI(firstNamed.id);
      const full = guessArtistTrackFullFromName(baseName);
      const parts = full.split(' - ').map(s=>s.trim()).filter(Boolean);

      if (!els.title.value.trim() && parts.length >= 2){
        const artist = parts[0];
        const track = removeTrailingParen(parts.slice(1).join(' - '));
        els.title.value = `${artist} - ${track}`;
      }
      if (!els.totalLabel.value.trim()){
        els.totalLabel.value = `${full} - все кампании`;
      }
    }

    function ensureIncludeState(){
      for (const c of campaignsAgg){
        if (!campaignIncluded.has(c.id)) campaignIncluded.set(c.id, true);
      }
    }

    function aggregateToCampaigns(){
      // Keys in exports; tolerant to minor variations
      const KEY_CAMPAIGN_ID = ['ID кампании','Campaign ID','campaign_id','CampaignId'];
      const KEY_GROUP_ID    = ['ID группы','Group ID','group_id','GroupId'];
      const KEY_GROUP_NAME  = ['Название группы','Group name','group_name','Name'];
      const KEY_STATUS      = ['Статус'];

      const KEY_SPEND       = ['Потрачено всего, ₽', 'Потрачено, ₽', 'Потрачено всего, ₽ '];
      const KEY_IMP         = ['Показы'];
      const KEY_LISTEN      = ['Начали прослушивание'];
      const KEY_ADDS        = ['Добавили аудио'];

      const map = new Map();

      for (const r of groupRows){
        const gid = String(getVal(r, KEY_GROUP_ID) ?? '').trim();
        const gname = String(getVal(r, KEY_GROUP_NAME) ?? '').trim();

        // If export doesn't contain "ID кампании", fallback to grouping by group id
        const cidRaw = getVal(r, KEY_CAMPAIGN_ID);
        const cid = String((cidRaw ?? '')).trim() || (gid ? `G:${gid}` : '');

        if (!cid) continue;

        const st = String(getVal(r, KEY_STATUS) ?? '').trim();
        const spend = asNumber(getVal(r, KEY_SPEND));
        const imp = asInt(getVal(r, KEY_IMP));
        const listen = asInt(getVal(r, KEY_LISTEN));
        const adds = asInt(getVal(r, KEY_ADDS));

        if (!map.has(cid)){
          map.set(cid, { id: cid, statuses: [], spend: 0, imp: 0, listen: 0, adds: 0, groupsCount: 0 });
        }
        const a = map.get(cid);
        a.groupsCount += 1;
        a.statuses.push(st);
        a.spend += spend;
        a.imp += imp;
        a.listen += listen;
        a.adds += adds;
      }

      campaignsAgg = Array.from(map.values())
        .map(a => ({
          id: a.id,
          statusRaw: groupStatusToCampaign(a.statuses),
          spend: a.spend,
          imp: a.imp,
          listen: a.listen,
          adds: a.adds,
          groupsCount: a.groupsCount
        }))
        .filter(c => !deletedCampaigns.has(c.id));

      // sort by name (empty last), then by id
      campaignsAgg.sort((x,y)=>{
        const nx = resolveCampaignNameForUI(x.id) || '';
        const ny = resolveCampaignNameForUI(y.id) || '';
        if (!nx && ny) return 1;
        if (nx && !ny) return -1;
        const cmp = nx.localeCompare(ny, 'ru', { sensitivity:'base' });
        if (cmp !== 0) return cmp;
        return String(x.id).localeCompare(String(y.id), 'ru', { sensitivity:'base' });
      });

      ensureIncludeState();
    }

    function renderTable(){
      if (!campaignsAgg.length){
        els.tableWrap.innerHTML = groupsLoaded
          ? 'Данные групп загружены, но не удалось собрать кампании (проверьте заголовки).'
          : 'Пока нет данных.';
        els.btnGenerate.disabled = true;
        return;
      }

      let html = `<table>
        <thead><tr>
          <th class="checkCell">✓</th>
          <th style="width:44%">Название кампании (авто)</th>
          <th style="width:14%">Статус</th>
          <th style="width:34%">Комментарий</th>
          <th class="actionsCell">Действия</th>
        </tr></thead><tbody>`;

      html += `<tr>
        <td class="checkCell">
          <input id="totalsInclude" type="checkbox" ${totalsIncluded ? 'checked' : ''} title="Показывать итоговый блок в сообщении">
        </td>
        <td><b>Итог (сумма по включённым кампаниям)</b></td>
        <td></td>
        <td>
          <input id="totalCommentInput" type="text" placeholder="Комментарий к суммарному блоку" value="${escapeHtmlAttr(totalComment)}">
        </td>
        <td></td>
      </tr>`;

      for (const c of campaignsAgg){
        const include = campaignIncluded.get(c.id) !== false;
        const fromReport = (campaignNamesFromReport.get(c.id) || '').trim();
        const override = (campaignNameOverrides.get(c.id) || '').trim();
        const displayName = resolveCampaignNameForUI(c.id); // may be empty
        const src = override ? 'ручн.' : (fromReport ? 'из отчёта кампаний' : '—');
        const isFallback = String(c.id).startsWith('G:');
        const curComment = campaignComments.get(c.id) || '';

        html += `<tr>
          <td class="checkCell">
            <input data-include="${escapeHtmlAttr(c.id)}" type="checkbox" ${include ? 'checked' : ''} title="Включать в сообщение">
          </td>
          <td>
            <div class="small">ID: <span class="mono">${escapeHtml(c.id)}</span> · групп: ${escapeHtml(String(c.groupsCount))} · источник: ${escapeHtml(src)}${isFallback ? ' · <span class="mutedLine">нет ID кампании в отчёте групп</span>' : ''}</div>
            <input data-cname="${escapeHtmlAttr(c.id)}" type="text" value="${escapeHtmlAttr(displayName)}" placeholder="(пусто) — введи название кампании">
            <div class="small">Из отчёта кампаний: ${fromReport ? escapeHtml(fromReport) : '—'}</div>
          </td>
          <td>
            <span class="nowrap">${escapeHtml(statusText(c.statusRaw))}</span>
            <div class="small mono">${escapeHtml(String(c.statusRaw || ''))}</div>
          </td>
          <td>
            <input data-ccomment="${escapeHtmlAttr(c.id)}" type="text" placeholder="Оставить пустым" value="${escapeHtmlAttr(curComment)}">
          </td>
          <td class="actionsCell">
            <button class="btn danger mini" data-delc="${escapeHtmlAttr(c.id)}">Удалить</button>
          </td>
        </tr>`;
      }

      html += `</tbody></table>`;
      els.tableWrap.innerHTML = html;

      // wire totals
      const totalsCb = document.getElementById('totalsInclude');
      totalsCb?.addEventListener('change', (e)=>{
        totalsIncluded = !!e.target.checked;
        buildMessage();
      });
      const totalInp = document.getElementById('totalCommentInput');
      totalInp?.addEventListener('input', (e)=>{
        totalComment = e.target.value;
        buildMessage();
      });

      // include
      els.tableWrap.querySelectorAll('input[data-include]').forEach(inp=>{
        inp.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-include');
          campaignIncluded.set(id, !!e.target.checked);
          buildMessage();
        });
      });

      // name override
      els.tableWrap.querySelectorAll('input[data-cname]').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-cname');
          const val = String(e.target.value || '');
          if (val.trim()) campaignNameOverrides.set(id, val);
          else campaignNameOverrides.delete(id);
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });

      // comment
      els.tableWrap.querySelectorAll('input[data-ccomment]').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-ccomment');
          campaignComments.set(id, e.target.value);
          buildMessage();
        });
      });

      // delete campaign (soft)
      els.tableWrap.querySelectorAll('button[data-delc]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.target.getAttribute('data-delc');
          deletedCampaigns.add(id);
          campaignIncluded.set(id, false);
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        });
      });

      els.btnGenerate.disabled = false;
    }

    function buildMessage(){
      const title = (els.title.value || '').trim();
      const totalsLabel = (els.totalLabel.value || '').trim();
      let out = '';

      if (title) out += `✅ ${title}\n\n`;

      // totals over included campaigns
      let sumSpend = 0, sumImp = 0, sumListen = 0, sumAdds = 0;
      for (const c of campaignsAgg){
        const include = campaignIncluded.get(c.id) !== false;
        if (!include) continue;
        sumSpend += asNumber(c.spend);
        sumImp += asInt(c.imp);
        sumListen += asInt(c.listen);
        sumAdds += asInt(c.adds);
      }

      for (const c of campaignsAgg){
        const include = campaignIncluded.get(c.id) !== false;
        if (!include) continue;

        const name = resolveCampaignNameForMessage(c.id);
        const comment = campaignComments.get(c.id) || '';

        const spend = asNumber(c.spend);
        const imp = asInt(c.imp);
        const listen = asInt(c.listen);
        const adds = asInt(c.adds);
        const cpa = (adds > 0) ? (spend / adds) : 0;

        out += `➡ ${name}\n\n`;
        out += `Потрачено: ${fmtMoney(spend)} ₽\n`;
        out += `Показы: ${fmtInt(imp)}\n`;
        out += `Начали прослушивание: ${fmtInt(listen)}\n`;
        out += `Добавлено: ${fmtInt(adds)}\n`;
        out += `Ср. стоимость добавления: ${adds>0 ? (fmtMoney(cpa) + ' ₽') : '—'}\n\n`;
        out += `Статус: ${statusText(c.statusRaw)}\n`;
        out += `Комментарий: ${comment}\n\n`;
      }

      if (totalsLabel && totalsIncluded){
        const totalCpa = (sumAdds > 0) ? (sumSpend / sumAdds) : 0;
        const totalStatus = (els.totalStatus?.value || '').trim();

        out += `➡ ${totalsLabel}\n\n`;
        out += `Потрачено: ${fmtMoney(sumSpend)} ₽\n`;
        out += `Показы: ${fmtInt(sumImp)}\n`;
        out += `Начали прослушивание: ${fmtInt(sumListen)}\n`;
        out += `Добавлено: ${fmtInt(sumAdds)}\n`;
        out += `Ср. стоимость добавления: ${sumAdds>0 ? (fmtMoney(totalCpa) + ' ₽') : '—'}\n\n`;
        out += `Статус: ${totalStatus}\n`;
        out += `Комментарий: ${totalComment}\n`;
      }

      els.output.value = out.trim() ? (out.trim() + '\n') : '';
      els.btnCopy.disabled = !els.output.value.trim();
    }

    // --- File handlers ---
    async function handleGroupsFile(file){
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = sheetToObjects(ws);
      groupRows = rows;
      groupsLoaded = rows.length > 0;
      return { count: rows.length, sheet: wb.SheetNames[0] };
    }

    async function handleCampaignsFile(file){
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = sheetToObjects(ws);

      campaignNamesFromReport.clear();

      const KEY_ID = ['ID кампании','Campaign ID','campaign_id','CampaignId'];
      const KEY_NAME = ['Название кампании','Campaign name','campaign_name','Name'];

      let count = 0;
      for (const r of rows){
        const id = String(getVal(r, KEY_ID) ?? '').trim();
        const name = String(getVal(r, KEY_NAME) ?? '').trim();
        if (!id || !name) continue;
        campaignNamesFromReport.set(id, name);
        count += 1;
      }

      campaignsReportLoaded = count > 0;
      return { count, sheet: wb.SheetNames[0] };
    }

    function resetForNewGroups(){
      groupRows = [];
      campaignsAgg = [];
      campaignComments.clear();
      campaignIncluded.clear();
      deletedCampaigns.clear();
      totalsIncluded = true;
      totalComment = '';
      els.output.value = '';
      els.btnCopy.disabled = true;
      els.btnGenerate.disabled = true;
      els.hint.textContent = '';
      els.copyHint.textContent = '';
      els.tableWrap.innerHTML = 'Пока нет данных.';
    }

    // --- UI events ---
    els.fileGroups.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f){
        resetForNewGroups();
        groupsLoaded = false;
        setPill();
        return;
      }

      try{
        resetForNewGroups();
        const res = await handleGroupsFile(f);
        setPill();

        if (!groupsLoaded){
          els.hint.textContent = 'Файл прочитан, но не найдено строк данных.';
          renderTable();
          return;
        }

        aggregateToCampaigns();
        guessTitleAndTotalsLabel();
        renderTable();
        buildMessage();

        els.hint.textContent = `Загружены группы: ${res.count} (лист: ${res.sheet}).`;
      }catch(err){
        console.error(err);
        resetForNewGroups();
        groupsLoaded = false;
        setPill();
        els.hint.textContent = `Ошибка чтения отчёта групп: ${String(err?.message || err)}`;
      }
    });

    els.fileCampaigns.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f){
        campaignNamesFromReport.clear();
        campaignsReportLoaded = false;
        setPill();
        if (groupsLoaded){
          aggregateToCampaigns();
          renderTable();
          buildMessage();
        }
        return;
      }

      try{
        const res = await handleCampaignsFile(f);
        setPill();
        if (groupsLoaded){
          aggregateToCampaigns();
          guessTitleAndTotalsLabel();
          renderTable();
          buildMessage();
        }
        els.hint.textContent = `Загружены имена кампаний: ${res.count} (лист: ${res.sheet}).`;
      }catch(err){
        console.error(err);
        campaignsReportLoaded = false;
        setPill();
        els.hint.textContent = `Ошибка чтения отчёта кампаний: ${String(err?.message || err)}`;
      }
    });

    els.btnGenerate.addEventListener('click', ()=>{
      if (!groupsLoaded || !campaignsAgg.length) return;
      buildMessage();
      els.hint.textContent = 'Готово. Скопируй справа.';
    });

    els.btnCopy.addEventListener('click', async ()=>{
      const text = els.output.value || '';
      if (!text.trim()) return;
      try{
        await navigator.clipboard.writeText(text);
        els.copyHint.textContent = 'Скопировано в буфер обмена.';
      }catch(e){
        els.output.focus();
        els.output.select();
        document.execCommand('copy');
        els.copyHint.textContent = 'Скопировано (через выделение).';
      }
    });

    els.title.addEventListener('input', ()=>{ if (groupsLoaded) buildMessage(); });
    els.totalLabel.addEventListener('input', ()=>{ if (groupsLoaded) buildMessage(); });
    els.totalStatus.addEventListener('change', ()=>{ if (groupsLoaded) buildMessage(); });

    // Clear buttons: remove loaded tables from file inputs
    els.btnClearGroups?.addEventListener('click', ()=>{
      els.fileGroups.value = '';
      resetForNewGroups();
      groupsLoaded = false;
      setPill();
    });

    els.btnClearCampaigns?.addEventListener('click', ()=>{
      els.fileCampaigns.value = '';
      campaignNamesFromReport.clear();
      campaignsReportLoaded = false;
      setPill();
      if (groupsLoaded){
        aggregateToCampaigns();
        renderTable();
        buildMessage();
      }
    });

    setPill();
</script>
</body>
</html>
